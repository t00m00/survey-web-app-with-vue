name: Codex CLI Integration

on:
  issues:
    types: [labeled]
  issue_comment:
    types: [created]
  pull_request_review:
    types: [submitted]

permissions:
  contents: write
  issues: write
  pull-requests: write
  actions: write

jobs:
  autonomous-coding:
    name: è‡ªå¾‹çš„ã‚³ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°
    runs-on: ubuntu-latest
    if: github.event.action == 'labeled' && contains(github.event.label.name, 'codex')

    steps:
      - name: ãƒªãƒã‚¸ãƒˆãƒªã‚’ãƒã‚§ãƒƒã‚¯ã‚¢ã‚¦ãƒˆ
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          fetch-depth: 0

      - name: Node.jsç’°å¢ƒã‚’ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—
        uses: actions/setup-node@v4
        with:
          node-version: "22"
          cache: "npm"

      - name: ä¾å­˜é–¢ä¿‚ã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
        run: npm ci

      - name: ãƒ–ãƒ©ãƒ³ãƒåã‚’ç”Ÿæˆ
        id: branch
        run: |
          ISSUE_NUMBER=${{ github.event.issue.number }}
          BRANCH_NAME="codex/issue-${ISSUE_NUMBER}-$(date +%s)"
          echo "name=${BRANCH_NAME}" >> $GITHUB_OUTPUT

      - name: æ–°ã—ã„ãƒ–ãƒ©ãƒ³ãƒã‚’ä½œæˆ
        run: |
          git config --local user.email "action@github.com"
          git config --local user.name "Codex Bot"
          git checkout -b ${{ steps.branch.outputs.name }}

      - name: Issueã®å†…å®¹ã‚’å–å¾—
        id: issue_content
        run: |
          ISSUE_TITLE="${{ github.event.issue.title }}"
          ISSUE_BODY="${{ github.event.issue.body }}"
          echo "title=${ISSUE_TITLE}" >> $GITHUB_OUTPUT
          echo "body<<EOF" >> $GITHUB_OUTPUT
          echo "${ISSUE_BODY}" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      - name: Codex CLIã§è‡ªå¾‹çš„ã‚³ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°ã‚’å®Ÿè¡Œ
        env:
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
          ISSUE_TITLE: ${{ steps.issue_content.outputs.title }}
          ISSUE_BODY: ${{ steps.issue_content.outputs.body }}
        run: |
          npm install -g @openai/codex
          export OPENAI_API_KEY="${{ secrets.OPENAI_API_KEY }}"

          cat > codex_ga_autonomous_coding_prompt.md << 'EOF'
          ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆ: Vue 3 ã‚¢ãƒ³ã‚±ãƒ¼ãƒˆ/ã‚¢ã‚»ã‚¹ãƒ¡ãƒ³ãƒˆ Web ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³

          ## Issueå†…å®¹:
          ã‚¿ã‚¤ãƒˆãƒ«: ${ISSUE_TITLE}
          èª¬æ˜Ž: ${ISSUE_BODY}

          ## æŒ‡ç¤º:
          1. CODEX.mdã®å†…å®¹ã‚’ç¢ºèªã—ã€ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£ã‚’ç†è§£ã—ã¦ãã ã•ã„
          2. Issueè¦æ±‚ã‚’æº€ãŸã™ã‚³ãƒ¼ãƒ‰ã‚’å®Ÿè£…ã—ã¦ãã ã•ã„
          3. æ—¢å­˜ã®ã‚³ãƒ¼ãƒ‰è¦ç´„ã«å¾“ã£ã¦ãã ã•ã„
          4. å¿…è¦ã«å¿œã˜ã¦ãƒ†ã‚¹ãƒˆã‚‚è¿½åŠ ã—ã¦ãã ã•ã„
          5. æ—¥æœ¬èªžã§ã‚³ãƒŸãƒƒãƒˆãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’è¨˜è¼‰ã—ã¦ãã ã•ã„

          ## åˆ¶ç´„:
          - Vue 3 Composition API + Vuetify 3ã‚’ä½¿ç”¨
          - ES6ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ã§ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆæ§‹æˆ
          - CDNçµŒç”±ã§èª­ã¿è¾¼ã‚€ãŸã‚ãƒ“ãƒ«ãƒ‰ä¸è¦
          - localStorageä½¿ç”¨ã§ãƒ‡ãƒ¼ã‚¿æ°¸ç¶šåŒ–
          EOF

          codex -a auto-edit --quiet "codex_ga_autonomous_coding_prompt.md ã®å†…å®¹ã«å¾“ã£ã¦"

      - name: å¤‰æ›´ã‚’ã‚³ãƒŸãƒƒãƒˆ
        run: |
          git add .
          if git diff --staged --quiet; then
            echo "å¤‰æ›´ãŒã‚ã‚Šã¾ã›ã‚“"
            exit 0
          fi

          git commit -m "ðŸ¤– Codex: Issue #${{ github.event.issue.number }} ã®è‡ªå‹•å®Ÿè£…

          ${{ steps.issue_content.outputs.title }}

          Auto-generated by Codex CLI"

      - name: ãƒ–ãƒ©ãƒ³ãƒã‚’ãƒ—ãƒƒã‚·ãƒ¥
        run: git push origin ${{ steps.branch.outputs.name }}

      - name: Pull Requestã‚’ä½œæˆ
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          gh pr create \
            --title "ðŸ¤– Codex: ${{ steps.issue_content.outputs.title }}" \
            --body "## æ¦‚è¦
          Issue #${{ github.event.issue.number }} ã«å¯¾ã™ã‚‹Codex CLIã«ã‚ˆã‚‹è‡ªå‹•å®Ÿè£…ã§ã™ã€‚

          ## å®Ÿè£…å†…å®¹
          ${{ steps.issue_content.outputs.body }}

          ## æ³¨æ„äº‹é …
          - ã“ã®å®Ÿè£…ã¯è‡ªå‹•ç”Ÿæˆã•ã‚ŒãŸã‚‚ã®ã§ã™
          - ãƒ¬ãƒ“ãƒ¥ãƒ¼ã‚’ãŠé¡˜ã„ã—ã¾ã™
          - å¿…è¦ã«å¿œã˜ã¦èª¿æ•´ã—ã¦ãã ã•ã„

          Closes #${{ github.event.issue.number }}" \
            --base main \
            --head ${{ steps.branch.outputs.name }}

  code-review:
    name: ã‚³ãƒ¼ãƒ‰ãƒ¬ãƒ“ãƒ¥ãƒ¼
    runs-on: ubuntu-latest
    if: |
      github.event_name == 'issue_comment' &&
      github.event.issue.pull_request &&
      contains(github.event.comment.body, '@codex') &&
      contains(github.event.comment.body, 'ãƒ¬ãƒ“ãƒ¥ãƒ¼')

    steps:
      - name: ãƒªãƒã‚¸ãƒˆãƒªã‚’ãƒã‚§ãƒƒã‚¯ã‚¢ã‚¦ãƒˆ
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Pull Requestæƒ…å ±ã‚’å–å¾—
        id: pr_info
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          PR_NUMBER=$(echo "${{ github.event.issue.number }}")
          PR_DATA=$(gh pr view ${PR_NUMBER} --json title,body,headRefName,baseRefName)
          echo "number=${PR_NUMBER}" >> $GITHUB_OUTPUT
          echo "data<<EOF" >> $GITHUB_OUTPUT
          echo "${PR_DATA}" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      - name: Pull Requestã®ãƒ•ã‚¡ã‚¤ãƒ«å·®åˆ†ã‚’å–å¾—
        id: pr_diff
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          PR_NUMBER=${{ steps.pr_info.outputs.number }}
          gh pr diff ${PR_NUMBER} > pr_diff.txt
          echo "diff_file=pr_diff.txt" >> $GITHUB_OUTPUT

      - name: Node.jsç’°å¢ƒã‚’ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—
        uses: actions/setup-node@v4
        with:
          node-version: "18"
          cache: "npm"

      - name: Codex CLIã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
        run: |
          npm install -g @openai/codex
          # ã¾ãŸã¯é©åˆ‡ãªCodex CLIã®ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«æ–¹æ³•

      - name: ã‚³ãƒ¼ãƒ‰ãƒ¬ãƒ“ãƒ¥ãƒ¼ã‚’å®Ÿè¡Œ
        env:
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
          COMMENT_BODY: ${{ github.event.comment.body }}
        run: |
          # ãƒ¬ãƒ“ãƒ¥ãƒ¼ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã‚’æº–å‚™
          cat > review_prompt.md << 'EOF'
          ## ã‚³ãƒ¼ãƒ‰ãƒ¬ãƒ“ãƒ¥ãƒ¼è¦æ±‚

          ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆ: Vue 3 ã‚¢ãƒ³ã‚±ãƒ¼ãƒˆ/ã‚¢ã‚»ã‚¹ãƒ¡ãƒ³ãƒˆ Web ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³

          ### ãƒ¬ãƒ“ãƒ¥ãƒ¼æŒ‡ç¤º:
          ${COMMENT_BODY}

          ### Pull Requestæƒ…å ±:
          ${{ steps.pr_info.outputs.data }}

          ### ãƒ•ã‚¡ã‚¤ãƒ«å·®åˆ†:
          ```diff
          $(cat ${{ steps.pr_diff.outputs.diff_file }})
          ```

          ### ãƒ¬ãƒ“ãƒ¥ãƒ¼è¦³ç‚¹:
          1. CODEX.mdã®è¨­è¨ˆæ–¹é‡ã«å¾“ã£ã¦ã„ã‚‹ã‹
          2. Vue 3 Composition API + Vuetify 3ã®é©åˆ‡ãªä½¿ç”¨
          3. ES6ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«æ§‹æˆã®å¦¥å½“æ€§
          4. ã‚³ãƒ¼ãƒ‰å“è³ªãƒ»å¯èª­æ€§
          5. ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ä¸Šã®å•é¡Œ
          6. ãƒ‘ãƒ•ã‚©ãƒ¼ãƒžãƒ³ã‚¹ã¸ã®å½±éŸ¿

          ### å‡ºåŠ›å½¢å¼:
          - æ—¥æœ¬èªžã§è¨˜è¼‰
          - å…·ä½“çš„ã§å»ºè¨­çš„ãªãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯
          - æ”¹å–„ææ¡ˆãŒã‚ã‚‹å ´åˆã¯ã‚³ãƒ¼ãƒ‰ä¾‹ã‚‚å«ã‚ã‚‹
          - å•é¡Œãªã„ãƒã‚¤ãƒ³ãƒˆã‚‚è©•ä¾¡ã™ã‚‹
          EOF

          # Codex CLIã§ãƒ¬ãƒ“ãƒ¥ãƒ¼ã‚’å®Ÿè¡Œ
          REVIEW_RESULT=$(codex -- --approval-mode full-auto --quiet "$(cat review_prompt.md)")
          echo "${REVIEW_RESULT}" > review_result.md

      - name: ãƒ¬ãƒ“ãƒ¥ãƒ¼ã‚³ãƒ¡ãƒ³ãƒˆã‚’æŠ•ç¨¿
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          PR_NUMBER=${{ steps.pr_info.outputs.number }}

          cat > final_comment.md << 'EOF'
          ## ðŸ¤– Codex ãƒ¬ãƒ“ãƒ¥ãƒ¼çµæžœ

          $(cat review_result.md)

          ---
          *ã“ã®ãƒ¬ãƒ“ãƒ¥ãƒ¼ã¯Codex CLIã«ã‚ˆã£ã¦è‡ªå‹•ç”Ÿæˆã•ã‚Œã¾ã—ãŸ*
          EOF

          gh pr comment ${PR_NUMBER} --body-file final_comment.md

  review-response:
    name: ãƒ¬ãƒ“ãƒ¥ãƒ¼å¿œç­”å‡¦ç†
    runs-on: ubuntu-latest
    if: |
      github.event_name == 'pull_request_review' &&
      contains(github.event.review.body, '@codex')

    steps:
      - name: ãƒªãƒã‚¸ãƒˆãƒªã‚’ãƒã‚§ãƒƒã‚¯ã‚¢ã‚¦ãƒˆ
        uses: actions/checkout@v4

      - name: ãƒ¬ãƒ“ãƒ¥ãƒ¼ã‚³ãƒ¡ãƒ³ãƒˆã«å¿œç­”
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          REVIEW_BODY="${{ github.event.review.body }}"
          PR_NUMBER=${{ github.event.pull_request.number }}

          cat > response.md << 'EOF'
          ## ðŸ¤– Codex ãƒ¬ãƒ“ãƒ¥ãƒ¼å¿œç­”

          ãƒ¬ãƒ“ãƒ¥ãƒ¼ã‚ã‚ŠãŒã¨ã†ã”ã–ã„ã¾ã™ï¼

          **ãƒ¬ãƒ“ãƒ¥ãƒ¼å†…å®¹:**
          ${REVIEW_BODY}

          **å¯¾å¿œæ–¹é‡:**
          ã”æŒ‡æ‘˜ã„ãŸã ã„ãŸç‚¹ã«ã¤ã„ã¦ç¢ºèªã—ã€å¿…è¦ã«å¿œã˜ã¦ä¿®æ­£ã„ãŸã—ã¾ã™ã€‚
          è¿½åŠ ã®@codexãƒ¬ãƒ“ãƒ¥ãƒ¼è¦æ±‚ãŒã‚ã‚Šã¾ã—ãŸã‚‰ã€ã‚³ãƒ¡ãƒ³ãƒˆã§ãŠçŸ¥ã‚‰ã›ãã ã•ã„ã€‚

          ---
          *ã“ã®å¿œç­”ã¯Codex CLIã«ã‚ˆã£ã¦è‡ªå‹•ç”Ÿæˆã•ã‚Œã¾ã—ãŸ*
          EOF

          gh pr comment ${PR_NUMBER} --body-file response.md
