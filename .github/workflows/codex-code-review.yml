name: Codex CLI code review

on:
  issue_comment:
    types: [created]

permissions:
  contents: write
  issues: write
  pull-requests: write
  actions: write

jobs:
  code-review:
    name: ã‚³ãƒ¼ãƒ‰ãƒ¬ãƒ“ãƒ¥ãƒ¼
    runs-on: ubuntu-latest
    if: |
      github.event_name == 'issue_comment' &&
      github.event.issue.pull_request &&
      contains(github.event.comment.body, '@codex') &&
      contains(github.event.comment.body, 'ãƒ¬ãƒ“ãƒ¥ãƒ¼')

    steps:
      - name: ãƒªãƒã‚¸ãƒˆãƒªã‚’ãƒã‚§ãƒƒã‚¯ã‚¢ã‚¦ãƒˆ
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Pull Requestæƒ…å ±ã‚’å–å¾—
        id: pr_info
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          PR_NUMBER=$(echo "${{ github.event.issue.number }}")
          PR_DATA=$(gh pr view ${PR_NUMBER} --json title,body,headRefName,baseRefName)
          echo "number=${PR_NUMBER}" >> $GITHUB_OUTPUT
          echo "data<<EOF" >> $GITHUB_OUTPUT
          echo "${PR_DATA}" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      - name: Pull Requestã®ãƒ•ã‚¡ã‚¤ãƒ«å·®åˆ†ã‚’å–å¾—
        id: pr_diff
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          PR_NUMBER=${{ steps.pr_info.outputs.number }}
          gh pr diff ${PR_NUMBER} > pr_diff.txt
          echo "diff_file=pr_diff.txt" >> $GITHUB_OUTPUT

      - name: Node.jsç’°å¢ƒã‚’ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—
        uses: actions/setup-node@v4
        with:
          node-version: "18"
          cache: "npm"

      - name: Codex CLIã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
        run: |
          npm install -g @openai/codex
          # ã¾ãŸã¯é©åˆ‡ãªCodex CLIã®ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«æ–¹æ³•

      - name: ã‚³ãƒ¼ãƒ‰ãƒ¬ãƒ“ãƒ¥ãƒ¼ã‚’å®Ÿè¡Œ
        env:
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
          COMMENT_BODY: ${{ github.event.comment.body }}
        run: |
          # ãƒ¬ãƒ“ãƒ¥ãƒ¼ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã‚’æº–å‚™
          cat > review_prompt.md << 'EOF'
          ## ã‚³ãƒ¼ãƒ‰ãƒ¬ãƒ“ãƒ¥ãƒ¼è¦æ±‚

          ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆ: Vue 3 ã‚¢ãƒ³ã‚±ãƒ¼ãƒˆ/ã‚¢ã‚»ã‚¹ãƒ¡ãƒ³ãƒˆ Web ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³

          ### ãƒ¬ãƒ“ãƒ¥ãƒ¼æŒ‡ç¤º:
          ${COMMENT_BODY}

          ### Pull Requestæƒ…å ±:
          ${{ steps.pr_info.outputs.data }}

          ### ãƒ•ã‚¡ã‚¤ãƒ«å·®åˆ†:
          ```diff
          $(cat ${{ steps.pr_diff.outputs.diff_file }})
          ```

          ### ãƒ¬ãƒ“ãƒ¥ãƒ¼è¦³ç‚¹:
          1. CODEX.mdã®è¨­è¨ˆæ–¹é‡ã«å¾“ã£ã¦ã„ã‚‹ã‹
          2. Vue 3 Composition API + Vuetify 3ã®é©åˆ‡ãªä½¿ç”¨
          3. ES6ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«æ§‹æˆã®å¦¥å½“æ€§
          4. ã‚³ãƒ¼ãƒ‰å“è³ªãƒ»å¯èª­æ€§
          5. ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ä¸Šã®å•é¡Œ
          6. ãƒ‘ãƒ•ã‚©ãƒ¼ãƒžãƒ³ã‚¹ã¸ã®å½±éŸ¿

          ### å‡ºåŠ›å½¢å¼:
          - æ—¥æœ¬èªžã§è¨˜è¼‰
          - å…·ä½“çš„ã§å»ºè¨­çš„ãªãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯
          - æ”¹å–„ææ¡ˆãŒã‚ã‚‹å ´åˆã¯ã‚³ãƒ¼ãƒ‰ä¾‹ã‚‚å«ã‚ã‚‹
          - å•é¡Œãªã„ãƒã‚¤ãƒ³ãƒˆã‚‚è©•ä¾¡ã™ã‚‹
          EOF

          # Codex CLIã§ãƒ¬ãƒ“ãƒ¥ãƒ¼ã‚’å®Ÿè¡Œ
          REVIEW_RESULT=$(codex -- --approval-mode full-auto --quiet "$(cat review_prompt.md)")
          echo "${REVIEW_RESULT}" > review_result.md

      - name: ãƒ¬ãƒ“ãƒ¥ãƒ¼ã‚³ãƒ¡ãƒ³ãƒˆã‚’æŠ•ç¨¿
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          PR_NUMBER=${{ steps.pr_info.outputs.number }}

          cat > final_comment.md << 'EOF'
          ## ðŸ¤– Codex ãƒ¬ãƒ“ãƒ¥ãƒ¼çµæžœ

          $(cat review_result.md)

          ---
          *ã“ã®ãƒ¬ãƒ“ãƒ¥ãƒ¼ã¯Codex CLIã«ã‚ˆã£ã¦è‡ªå‹•ç”Ÿæˆã•ã‚Œã¾ã—ãŸ*
          EOF

          gh pr comment ${PR_NUMBER} --body-file final_comment.md
